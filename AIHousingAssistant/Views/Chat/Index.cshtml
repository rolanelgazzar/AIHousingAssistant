@{
    ViewData["Title"] = "Housing Chat Assistant";
    Layout = null;
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style type="text/css">
        /* Variables - Original Colors */
        :root {
            --primary-color-dark: #00008B;
            --primary-color: #4169e1;
            --secondary-color: #191970;
            --header-bg: #4169e1;
            --body-bg: linear-gradient(135deg, #f5f5dc 0%, #fff8e1 100%);
            --sidebar-bg-new: #ffffff;
            --sidebar-text-color: #212529;
            --sidebar-element-bg: #f8f8e8;
            --user-msg-bg: #FFFFFF;
            --bot-msg-bg: #F0F8FF;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--body-bg);
            height: 100vh;
            margin: 0;
            display: flex;
            overflow: hidden;
            direction: ltr; /* Sidebar on the Left */
        }

        /* ========== SIDEBAR (LEFT) ========== */
        .chat-sidebar {
            width: 320px;
            background: var(--sidebar-bg-new);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            border-right: 1px solid #e0e0e0;
            z-index: 10;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color-dark);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--primary-color);
        }

        .config-section {
            background: var(--sidebar-element-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

            .config-section h4 {
                font-size: 14px;
                margin-bottom: 10px;
                color: var(--sidebar-text-color);
            }

            .config-section select, .config-section input {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 13px;
            }

        .load-summary-btn {
            width: 100%;
            background: var(--primary-color-dark);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ========== MAIN CHAT ========== */
        .msger {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .msger-header {
            background: var(--header-bg);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .msger-chat {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: rgba(255, 255, 255, 0.5);
        }

        .msg {
            display: flex;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .msg-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 0 10px;
            border: 2px solid var(--primary-color);
            background-size: cover;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 15px;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .left-msg .msg-bubble {
            background: var(--bot-msg-bg);
            border-bottom-left-radius: 4px;
        }

        .right-msg {
            flex-direction: row-reverse;
        }

            .right-msg .msg-bubble {
                background: var(--user-msg-bg);
                border-bottom-right-radius: 4px;
                border: 1px solid #e0e0e0;
            }

        .msger-inputarea {
            padding: 20px 40px;
            background: transparent;
        }

        .input-bar-wrapper {
            background: white;
            border-radius: 30px;
            padding: 8px 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .msger-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px;
            font-size: 15px;
            background: transparent;
            direction: rtl;
        }

        .tools-dropdown {
            border: 1px solid #dfe1e5;
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #fileNamesDisplay {
            margin: 15px 50px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .file-card {
            background: #ffffff;
            color: var(--primary-color-dark);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .question-btn {
            background: #ffffff;
            border: 1px solid #cccccc;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            width: 100%;
            text-align: right;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <aside class="chat-sidebar">
        <div class="sidebar-title">⚙️ Settings RAG</div>

        <div class="config-section">
            <h4>🧠 Embedding Model</h4>
            <select id="embeddingModel">
                <option value="0">Nomic Embed Text</option>
                <option value="1">Text Embedding 3 Small</option>
            </select>
        </div>

        <div class="config-section">
            <h4>✂️ Chunking Strategy</h4>
            <select id="chunkingMode">
                <option value="0">LangChain Recursive</option>
                <option value="1">Recursive Text Splitter</option>
                <option value="2">Semantic Text Blocks</option>
            </select>
        </div>

        <div class="config-section">
            <h4>🗄️ Vector Store Provider</h4>
            <select id="vectorStoreProvider">
                <option value="0">Qdrant SDK</option>
                <option value="1">Qdrant Http</option>
                <option value="2">In-Memory</option>
            </select>
        </div>

        <div class="config-section">
            <h4>🔍 Search Mode</h4>
            <select id="searchMode">
                <option value="0">Vector</option>
                <option value="1">Semantic</option>
                <option value="2">Hybrid</option>
            </select>
        </div>

        <div class="config-section">
            <h4>🧠 AI Provider</h4>
            <select id="AIProvider">
                <option value="0">Ollama</option>
                <option value="1">Open AI</option>
                <option value="2">KernelMemory</option>
            </select>
        </div>

        <div class="config-section">
            <h4>🤝 Top Similarity</h4>
            <input type="text" id="topSimilarity" value="3" />
        </div>

        <div class="config-section">
            <h4>❓ Help Questions</h4>
            <div id="initialQuestions"></div>
        </div>

        <div class="summary-section">
            <button class="load-summary-btn" id="loadSummaryBtn">View Summary</button>
            <div id="summaryResult" style="margin-top:10px; font-size:12px;"></div>
        </div>
    </aside>

    <section class="msger">
        <header class="msger-header">
            <div class="msger-header-title">Service Bot - RAG Enhanced</div>
        </header>

        <main class="msger-chat" id="chatBox"></main>

        <div class="msger-inputarea">
            <div class="input-bar-wrapper">
                <label for="fileUpload" class="attach-btn" style="cursor:pointer; color:#5f6368; font-size: 1.2rem;">
                    <i class="fas fa-plus"></i>
                </label>
                <input type="file" id="fileUpload" style="display:none;" multiple accept=".pdf,.txt,.docx">

                <input type="text" id="messageInput" class="msger-input" placeholder="Type your question here..." style="direction: ltr; text-align: left;">
                <select id="toolSelector" class="tools-dropdown">
                    <option value="DirectChat" data-name="Direct Chat">🔍 Direct Chat</option>
                    <option value="PluginDB" data-name="Plugin DB">🗄️ Plugin DB</option>
                    <option value="Web" data-name="Web Search">🌐 Web Search</option>
                    <option value="KernelMemory" data-name="Kernel Memory">📝 Kernel Memory</option>
                    <option value="Rag" data-name="Custom Rag">⚙️ Custom Rag</option>
                </select>

                <button id="mainSendBtn" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <div id="fileNamesDisplay"></div>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script>
        // Static assets
        const imgBOT = "/images/bot.png";
        const imgPerson = "/images/user.png";
        let selectedFiles = [];

        $(document).ready(function() {
            // Initial UI setup
            addMessage("Hello! I am your smart assistant. How can I help you today?", 'bot');
            loadInitialQuestions();

            // File Upload Event
            $('#fileUpload').on('change', function(e) {
                handleFileUpload(e);
                $(this).val('');
            });

            // Summary Button Event
            $('#loadSummaryBtn').on('click', function() {
                loadSummary();
            });

            // Main Send Action
            $('#mainSendBtn').on('click', function() {
                const msg = $('#messageInput').val().trim();
                const tool = $('#toolSelector').val();

                if (!msg) return;

                // Show user message
                addMessage(msg, 'user');
                $('#messageInput').val('');

                // Routing to specific tool functions
                switch(tool) {
                    case 'DirectChat':   askDirectChat(msg); break;
                    case 'PluginDB':     askPluginDB(msg); break;
                    case 'Web':          askWeb(msg); break;
                    case 'Rag':          askRag(msg); break;
                    case 'KernelMemory': askKernelMemory(msg); break;
                   
                    default:             askDirectChat(msg);
                }

                // Reset local state
               // selectedFiles = [];
               // renderFiles();
            });
        });

        // --- Tool Call Implementations ---

        function askDirectChat(q) { sendAiRequest('/AskChatAI', q); }
        function askPluginDB(q)   { sendAiRequest('/AskPluginDB', q); }
        function askWeb(q)        { sendAiRequest('/AskWeb', q); }
        function askRag(q)        { sendAiRequest('/AskRag', q); }
        function askKernelMemory(q) { sendAiRequest('/AskKernelMemory', q); }

        /**
         * Generic AJAX wrapper for AI requests
         */
                  function sendAiRequest(url, query) {
            // English comment: Prepare the request payload with selected UI values
            const payload = {
                Query: query,
                SessionId: "User_123", // English comment: Maintain session for history context
                VectorDbProvider: parseInt($('#vectorStoreProvider').val()),
                ChunkingMode: parseInt($('#chunkingMode').val()),
                EmbeddingModel: parseInt($('#embeddingModel').val()),
                SearchMode: parseInt($('#searchMode').val()),
                AIProvider: parseInt($('#AIProvider').val()),
                TopSimilarity: parseInt($('#topSimilarity').val())
            };

            showLoader();

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    hideLoader();

                    // English comment: Map response data (adjusting for camelCase)
                    const botReply = res.answer || "No response received.";
                    const sources = res.sources || [];
                    const chunkIndexes = res.chunkIndexes || [];
                    const similarities = res.similarity || [];

                    // English comment: Get the text label for the selected search mode
                    const searchModeLabel = $('#searchMode option:selected').text();

                    // English comment: Construct the metadata header
                    let metadataHtml = "";
                    if (sources.length > 0 || chunkIndexes.length > 0) {
                        // English comment: Styling the box to appear as a header above the text
                        metadataHtml += `<div class="metadata-box" style="font-size: 0.8em; border-bottom: 1px solid #ddd; margin-bottom: 8px; padding-bottom: 5px; color: #666;">`;

                        // English comment: Display the Search Mode used for this specific request
                        metadataHtml += `🔍 <b>Search Mode:</b> ${searchModeLabel}<br/>`;

                        if (sources.length > 0) {
                            metadataHtml += `📚 <b>Sources:</b> ${[...new Set(sources)].join(', ')}<br/>`;
                        }
                        if (chunkIndexes.length > 0) {
                            metadataHtml += `🧩 <b>Chunk Indexes:</b> ${chunkIndexes.join(', ')}<br/>`;
                        }
                        if (similarities.length > 0) {
                            const topScore = (Math.max(...similarities) * 100).toFixed(1);
                            metadataHtml += `🎯 <b>TopK:</b> ${topScore}%`;
                        }

                        metadataHtml += `</div>`;
                    }

                    // English comment: Combine metadata at the TOP, then the bot answer
                    const fullMessage = `${metadataHtml}${botReply}`;
                    addMessage(fullMessage, 'bot');
                },
                error: function(xhr) {
                    hideLoader();
                    const err = xhr.responseJSON?.error || "Request failed.";
                    addMessage("❌ Error: " + err, 'bot');
                }
            });
        }

                // --- Helper Functions ---

                   function handleFileUpload(event) {
                       removeAllFiles();
            const files = event.target.files;
            if (!files.length) return;

            // Capture selected options text for the success message
            const selectedOptions = {
                embedding: $("#embeddingModel option:selected").text(),
                vectorDb: $("#vectorStoreProvider option:selected").text(),
                searchMode: $("#searchMode option:selected").text(),
                aiProvider: $("#AIProvider option:selected").text(),
                tool: $("#toolSelector option:selected").attr("data-name") || $("#toolSelector option:selected").text()
            };

            const formData = new FormData();
            // Temporarily store files to be uploaded
            const currentUploadSet = Array.from(files);

            currentUploadSet.forEach(f => {
                formData.append("files", f);
                selectedFiles.push(f);
            });

            renderFiles();

            // Append metadata for RAG processing
            formData.append("VectorDbProvider", $('#vectorStoreProvider').val());
            formData.append("ChunkingMode", $('#chunkingMode').val());
            formData.append("EmbeddingModel", $('#embeddingModel').val());
            formData.append("SearchMode", $('#searchMode').val());
            formData.append("AIProvider", $('#AIProvider').val());
            formData.append("ToolsSearchBy", $('#toolSelector').val());
            formData.append("TopSimilarity", $('#topSimilarity').val());

            // Show processing loader
            showLoader("Proceeding documents...");

            $.ajax({
                url: '/UploadDocument',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function() {
                    hideLoader();

                    // Construct a detailed success message
                    let successDetail = `
                        <b>✅ Documents Uploaded & Processed successfully!</b><br/>
                        <small style="color: #555;">
                            <b>Model:</b> ${selectedOptions.embedding} <br/>
                            <b>Vector DB:</b> ${selectedOptions.vectorDb} <br/>
                            <b>Search:</b> ${selectedOptions.searchMode} <br/>
                            <b>AI Provider:</b> ${selectedOptions.aiProvider} <br/>
                            <b>Tool Used:</b> ${selectedOptions.tool}
                        </small>
                    `;

                    addMessage(successDetail, 'bot');
                },
                error: function(xhr) {
                    hideLoader();

                    // 1. Clear the global files array on error
                    selectedFiles = [];

                    // 2. Refresh the UI to remove the file cards
                    renderFiles();

                    // 3. Display the error message from the server
                    const err = xhr.responseJSON?.error || "Upload failed.";
                    addMessage("❌ Error: " + err, 'bot');

                    // 4. Reset the file input element so the user can try again
                    $(event.target).val('');
                }
            });
        }

        function renderFiles() {
            const display = $('#fileNamesDisplay');
            display.empty();
            selectedFiles.forEach((file, i) => {
                display.append(`
                    <div class="file-card">
                        <span><i class="fas fa-file"></i> ${file.name}</span>
                        <i class="fas fa-trash file-delete-btn" style="color:red; cursor:pointer" onclick="removeFile(${i})"></i>
                    </div>`);
            });
        }

        window.removeFile = function(i) {
            selectedFiles.splice(i, 1);
            renderFiles();
        };
        window.removeAllFiles = function() {
            selectedFiles = [];
            renderFiles();
        };

        function loadInitialQuestions() {
            $.get('/GetInitialQuestions', function(res) {
                if (res.success) {
                    const container = $('#initialQuestions');
                    container.empty();
                    res.data.forEach(q => {
                        const btn = $(`<button class="question-btn">${q}</button>`);
                        btn.on('click', function() {
                            $('#messageInput').val(q);
                            $('#mainSendBtn').click();
                        });
                        container.append(btn);
                    });
                }
            });
        }

        function loadSummary() {
            $('#summaryResult').text('Processing...');
            $.get('/SummarizationChatHistory', function(res) {
                $('#summaryResult').text(res.success ? res.summary : "No summary.");
            });
        }

        function addMessage(text, sender) {
            const isUser = sender === 'user';
            const html = `
                <div class="msg ${isUser ? 'right-msg' : 'left-msg'}">
                    <div class="msg-img" style="background-image: url(${isUser ? imgPerson : imgBOT})"></div>
                    <div class="msg-bubble"><div class="msg-text">${text}</div></div>
                </div>`;
            $('#chatBox').append(html);
            $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
        }

        function showLoader() {
            addMessage('<i class="fas fa-spinner fa-spin"></i> Processing documents, please wait...', 'bot');
        }        function hideLoader() { $('#chatBox .msg:last-child').has('.fa-spinner').remove(); }
    </script>
</body>
</html>